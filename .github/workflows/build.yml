# .github/workflows/build.yml

name: DH-Blog Build and Release

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# å…¨å±€çŽ¯å¢ƒå˜é‡ï¼Œè¿™é‡Œçš„è·¯å¾„æ˜¯ç›¸å¯¹äºŽé¡¹ç›®æ ¹ç›®å½•çš„ï¼Œå› ä¸º Actions ä»Žæ ¹ç›®å½•å¼€å§‹
env:
  BINARY_NAME: dhblog
  BACKEND_DIR: blog-backend   # ä»Žæ ¹ç›®å½•å‡ºå‘ï¼Œç›´æŽ¥å°±æ˜¯ 'blog-backend'
  FRONTEND_DIR: blog-front    # ä»Žæ ¹ç›®å½•å‡ºå‘ï¼Œç›´æŽ¥å°±æ˜¯ 'blog-front'

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  build-and-release:
    name: ðŸ—ï¸ Build All Platforms
    runs-on: ubuntu-latest
    
    # ä»»åŠ¡æ‰§è¡Œçš„æ­¥éª¤
    steps:
      # æ­¥éª¤ 1: æ‹‰å–ä»£ç 
      # å·¥ä½œç›®å½•: /home/runner/work/DH-Blog/DH-Blog/
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: å®‰è£… pnpm
      # å·¥ä½œç›®å½•: /home/runner/work/DH-Blog/DH-Blog/
      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      # æ­¥éª¤ 3: è®¾ç½® Node.js çŽ¯å¢ƒ
      # å·¥ä½œç›®å½•: /home/runner/work/DH-Blog/DH-Blog/
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          # ç¼“å­˜è·¯å¾„ä¹Ÿæ˜¯ä»Žæ ¹ç›®å½•è®¡ç®—çš„: 'blog-front/pnpm-lock.yaml'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/pnpm-lock.yaml'

      # æ­¥éª¤ 4: å®‰è£…å‰ç«¯ä¾èµ–å¹¶æž„å»º
      # ä½¿ç”¨ `working-directory` åˆ‡æ¢åˆ°å‰ç«¯ç›®å½•ï¼Œå®Œç¾Žæ¨¡æ‹Ÿ `(cd ../blog-front && ...)`
      - name: ðŸ“¦ Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "==> Current directory: $(pwd)"
          echo "==> Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "==> Building frontend..."
          pnpm build

      # æ­¥éª¤ 5: è®¾ç½® Go çŽ¯å¢ƒ
      # å·¥ä½œç›®å½•: /home/runner/work/DH-Blog/DH-Blog/
      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: '${{ env.BACKEND_DIR }}/go.sum'

      # æ­¥éª¤ 6: å‡†å¤‡åµŒå…¥ç›®å½•å¹¶æž„å»ºæ‰€æœ‰å¹³å°
      # å›žåˆ°æ ¹ç›®å½•æ‰§è¡Œï¼Œç¡®ä¿æ‰€æœ‰è·¯å¾„æ¸…æ™°
      - name: ðŸ› ï¸ Build Go Binaries for All Platforms
        run: |
          # å®šä¹‰å˜é‡ï¼Œè·¯å¾„å…¨éƒ¨ä»Žæ ¹ç›®å½•å¼€å§‹ï¼Œæ¸…æ™°æ˜Žäº†
          DEPLOY_DIR="build"
          EMBED_DIR="${{ env.BACKEND_DIR }}/internal/frontend/dist"
          
          echo "==> Preparing directories..."
          rm -rf "$DEPLOY_DIR" "$EMBED_DIR"
          mkdir -p "$DEPLOY_DIR" "$EMBED_DIR"
          
          echo "==> Embedding frontend files..."
          # ä»Ž 'blog-front/dist' å¤åˆ¶åˆ° 'blog-backend/internal/frontend/dist'
          cp -r "${{ env.FRONTEND_DIR }}/dist/"* "$EMBED_DIR/"
          
          # å®šä¹‰æž„å»ºå‡½æ•°
          build_for_platform() {
              local os=$1 arch=$2 ext=$3
              local output_name="${BINARY_NAME}${ext}"
              local output_path="${DEPLOY_DIR}/${output_name}"
              
              echo "==> Building for ${os}/${arch}..."
              cd "${BACKEND_DIR}"
              GOOS="${os}" GOARCH="${arch}" go build -ldflags="-s -w" -o "../${output_path}" ./cmd/blog-backend
              cd ..
              
              echo "==> Built: ${output_path}"
          }
          
          # æž„å»ºæ‰€æœ‰å¹³å°
          build_for_platform "darwin" "arm64" "-darwin-arm64"
          build_for_platform "windows" "amd64" "-windows-amd64.exe"
          build_for_platform "linux" "amd64" "-linux-amd64"
          
          echo "==> All builds completed!"
          ls -la "${DEPLOY_DIR}/"

      # æ­¥éª¤ 7: ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° GitHub Release
      - name: ðŸ“¤ Upload Release Asset
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: build/*
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
