# .github/workflows/build.yml

name: DH-Blog Build and Release (Diagnostic Version)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  BINARY_NAME: dhblog
  BACKEND_DIR: blog-backend
  FRONTEND_DIR: blog-front

jobs:
  build-and-release:
    name: ğŸ—ï¸ Build and Diagnose
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ‹‰å–ä»£ç 
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: å®‰è£… pnpm
      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      # æ­¥éª¤ 3: è®¾ç½® Node.js ç¯å¢ƒ
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/pnpm-lock.yaml'

      # ====================================================================
      # æ­¥éª¤ 4: ç»ˆæè¯Šæ–­æ­¥éª¤
      # è¿™ä¸€æ­¥ä¼šæ‰“å°å‡º CI ç¯å¢ƒä¸­æ–‡ä»¶çš„çœŸå®çŠ¶æ€å’Œå†…å®¹
      # ====================================================================
      - name: ğŸ” Diagnose File Contents
        run: |
          echo "================== DIAGNOSTIC STEP START =================="
          echo " "
          echo ">>> Listing files in the frontend directory:"
          ls -la ${{ env.FRONTEND_DIR }}
          echo " "
          echo "---------------------------------------------------------"
          echo ">>> Displaying content of package.json:"
          echo " "
          cat ${{ env.FRONTEND_DIR }}/package.json
          echo " "
          echo "---------------------------------------------------------"
          echo ">>> Displaying content of pnpm-lock.yaml:"
          echo " "
          # ä½¿ç”¨ || true æ¥é˜²æ­¢åœ¨æ–‡ä»¶ä¸å­˜åœ¨æ—¶å¯¼è‡´å·¥ä½œæµå¤±è´¥
          cat ${{ env.FRONTEND_DIR }}/pnpm-lock.yaml || echo "!!! pnpm-lock.yaml NOT FOUND by 'cat' command !!!"
          echo " "
          echo "================== DIAGNOSTIC STEP END ===================="

      # æ­¥éª¤ 5: å®‰è£…å‰ç«¯ä¾èµ–å¹¶æ„å»º
      - name: ğŸ“¦ Build Frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "==> Current directory: $(pwd)"
          echo "==> Installing dependencies..."
          pnpm install --frozen-lockfile
          echo "==> Building frontend..."
          pnpm build

      # æ­¥éª¤ 6: è®¾ç½® Go ç¯å¢ƒ
      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: '${{ env.BACKEND_DIR }}/go.sum'

      # æ­¥éª¤ 7: å‡†å¤‡åµŒå…¥ç›®å½•å¹¶æ„å»ºæ‰€æœ‰å¹³å°
      - name: ğŸ› ï¸ Build Go Binaries for All Platforms
        run: |
          DEPLOY_DIR="build"
          EMBED_DIR="${{ env.BACKEND_DIR }}/internal/frontend/dist"
          
          echo "==> Preparing directories..."
          rm -rf "$DEPLOY_DIR" "$EMBED_DIR"
          mkdir -p "$DEPLOY_DIR" "$EMBED_DIR"
          
          echo "==> Embedding frontend files..."
          cp -r "${{ env.FRONTEND_DIR }}/dist/"* "$EMBED_DIR/"
          
          build_for_platform() {
              local os=$1 arch=$2 ext=$3
              local output_path="$DEPLOY_DIR/${{ env.BINARY_NAME }}${ext}"
              echo "==> Building for $os/$arch..."
              (cd "${{ env.BACKEND_DIR }}" && GOOS=$os GOARCH=$arch go build -ldflags="-s -w" -o "../$output_path" ./cmd/blog-backend)
              if [ $? -eq 0 ]; then
                  echo "âœ… Successfully built: $output_path"
              else
                  echo "âŒ Failed to build for $os/$arch"
                  exit 1
              fi
          }

          build_for_platform "darwin" "arm64" "-darwin-arm64"
          build_for_platform "windows" "amd64" "-windows-amd64.exe"
          build_for_platform "linux" "amd64" "-linux-amd64"
          
          echo "==> Cleaning up intermediate files..."
          rm -rf "$EMBED_DIR"
          
          echo "==> All builds complete! Artifacts are in the $DEPLOY_DIR directory."

      # æ­¥éª¤ 8: ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: â¬†ï¸ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dhblog-binaries
          path: build/