# .github/workflows/build.yml

# å·¥ä½œæµåç§°
name: DH-Blog Build

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  push:
    branches: [ "main" ] # 1. å½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ "main" ] # 2. å½“æœ‰ Pull Request æŒ‡å‘ main åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:      # 3. å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘

# å…¨å±€ç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†å’Œä¿®æ”¹
env:
  BINARY_NAME: dhblog
  BACKEND_DIR: blog-backend
  FRONTEND_DIR: blog-front

# å®šä¹‰å·¥ä½œä»»åŠ¡
jobs:
  # --------------------------------------------------
  # ä»»åŠ¡ä¸€ï¼šæ„å»ºå‰ç«¯èµ„æº
  # --------------------------------------------------
  build-frontend:
    # ä»»åŠ¡çš„æ˜¾ç¤ºåç§°
    name: ğŸ“¦ Build Frontend
    # è¿è¡Œæ­¤ä»»åŠ¡çš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # ä»»åŠ¡æ‰§è¡Œçš„æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç åˆ°è™šæ‹Ÿæœº
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£… pnpm CLIï¼ˆè¿™æ˜¯å…³é”®ä¿®å¤æ­¥éª¤ï¼‰
      - name: âš™ï¸ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8 # ä½ å¯ä»¥æŒ‡å®šéœ€è¦çš„ pnpm ç‰ˆæœ¬

      # æ­¥éª¤3ï¼šè®¾ç½® Node.js ç¯å¢ƒï¼Œå¹¶é…ç½® pnpm ç¼“å­˜
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22' # ä½¿ç”¨ Node.js 22
          cache: 'pnpm'      # å¯ç”¨ pnpm ç¼“å­˜
          cache-dependency-path: '${{ env.FRONTEND_DIR }}/pnpm-lock.yaml'

      # æ­¥éª¤4ï¼šå®‰è£…å‰ç«¯ä¾èµ–ã€‚--frozen-lockfile ç¡®ä¿ä½¿ç”¨é”æ–‡ä»¶ä¸­çš„ç¡®åˆ‡ç‰ˆæœ¬ï¼Œä¿è¯ CI ç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚
      - name: ğŸ“¥ Install frontend dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: pnpm install --frozen-lockfile

      # æ­¥éª¤5ï¼šæ„å»ºå‰ç«¯é¡¹ç›®
      - name: ğŸ—ï¸ Build frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: pnpm build

      # æ­¥éª¤6ï¼šå‡†å¤‡ç”¨äºåµŒå…¥åˆ° Go ç¨‹åºä¸­çš„å‰ç«¯æ–‡ä»¶
      - name: ğŸ“ Prepare files for embedding
        run: |
          # åˆ›å»ºåç«¯ç”¨äºåµŒå…¥çš„å‰ç«¯æ–‡ä»¶ç›®å½•
          mkdir -p ${{ env.BACKEND_DIR }}/internal/frontend/dist
          # å°†æ„å»ºå¥½çš„å‰ç«¯æ–‡ä»¶å¤åˆ¶è¿‡å»
          cp -r ${{ env.FRONTEND_DIR }}/dist/* ${{ env.BACKEND_DIR }}/internal/frontend/dist/
      
      # æ­¥éª¤7ï¼šå°†åŒ…å«å‰ç«¯äº§ç‰©çš„æ•´ä¸ªé¡¹ç›®ä¸Šä¼ ä¸º artifactï¼Œä¾›ä¸‹ä¸€ä¸ªä»»åŠ¡ä½¿ç”¨
      - name: â¬†ï¸ Upload artifact for next job
        uses: actions/upload-artifact@v4
        with:
          name: prepared-source
          path: . # ä¸Šä¼ æ•´ä¸ªé¡¹ç›®ç›®å½•ï¼Œæ­¤æ—¶å·²åŒ…å«åµŒå…¥çš„å‰ç«¯æ–‡ä»¶

  # --------------------------------------------------
  # ä»»åŠ¡äºŒï¼šæ„å»ºè·¨å¹³å°çš„ Go äºŒè¿›åˆ¶æ–‡ä»¶
  # --------------------------------------------------
  build-go-binaries:
    # ä»»åŠ¡çš„æ˜¾ç¤ºåç§°
    name: ğŸ› ï¸ Build Go Binaries
    # ä¾èµ–å…³ç³»ï¼šæ­¤ä»»åŠ¡å¿…é¡»ç­‰å¾… build-frontend æˆåŠŸåæ‰èƒ½å¼€å§‹
    needs: build-frontend 
    # è¿è¡Œæ­¤ä»»åŠ¡çš„è™šæ‹Ÿæœºç¯å¢ƒ
    runs-on: ubuntu-latest
    
    # æ„å»ºçŸ©é˜µï¼šå¹¶è¡Œæ„å»ºå¤šä¸ªå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
    strategy:
      matrix:
        # å®šä¹‰ä¸åŒå¹³å°çš„æ„å»ºå‚æ•°
        include:
          - os: darwin
            arch: arm64
            ext: "-darwin-arm64"
          - os: windows
            arch: amd64
            ext: "-windows-amd64.exe"
          - os: linux
            arch: amd64
            ext: "-linux-amd64"
            
    # ä»»åŠ¡æ‰§è¡Œçš„æ­¥éª¤
    steps:
      # æ­¥éª¤1ï¼šä¸‹è½½ä¸Šä¸€ä¸ªä»»åŠ¡å‡†å¤‡å¥½çš„ã€åŒ…å«å‰ç«¯æ–‡ä»¶çš„æºç 
      - name: â¬‡ï¸ Download prepared source code
        uses: actions/download-artifact@v4
        with:
          name: prepared-source

      # æ­¥éª¤2ï¼šè®¾ç½® Go ç¯å¢ƒï¼Œå¹¶é…ç½® Go æ¨¡å—ç¼“å­˜
      - name: âš™ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # ä½ çš„æ–‡ä»¶å†™çš„æ˜¯1.24ï¼Œæˆ‘æ”¹å›1.22ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
          cache-dependency-path: '${{ env.BACKEND_DIR }}/go.sum'

      # æ­¥éª¤3ï¼šæ ¹æ®çŸ©é˜µä¸­çš„å¹³å°ä¿¡æ¯è¿›è¡Œè·¨å¹³å°ç¼–è¯‘
      - name: ğŸ—ï¸ Build for ${{ matrix.os }}/${{ matrix.arch }}
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          # è®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ„å»º
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -ldflags="-s -w" -o ../build/${{ env.BINARY_NAME }}${{ matrix.ext }} ./cmd/blog-backend
          echo "âœ… Built: ${{ env.BINARY_NAME }}${{ matrix.ext }}"

      # æ­¥éª¤4ï¼šå°†ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ†åˆ«ä¸Šä¼ ä¸º artifact
      - name: â¬†ï¸ Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}${{ matrix.ext }}
          path: build/${{ env.BINARY_NAME }}${{ matrix.ext }}