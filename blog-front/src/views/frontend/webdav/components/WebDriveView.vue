<template>
  <div class="web-drive-container">
    <!-- ÁßªÂä®Á´ØËßÜÂõæ -->
    <MobileView v-if="isMobile" :mobile-files="convertedFiles" @upload="openUploadModal" @open="handleMobileFileOpen"
      @share="shareFile" @download="downloadFile" @rename="handleMobileRename" @delete="deleteFile" />

    <!-- Ê°åÈù¢Á´ØËßÜÂõæ -->
    <div v-else class="desktop-view">
      <!-- Êñá‰ª∂È¢ÑËßàÁªÑ‰ª∂ -->
      <FilePreview v-if="showFilePreview" :file="selectedFile" @close="closeFilePreview" />

      <template v-else>
        <div class="browser-header">
          <div class="header-left">
            <div class="breadcrumb">
              <HomeIcon class="icon-sm" @click="navigateToRoot" />
              <template v-if="pathSegments.length > 0">
                <ChevronRightIcon class="icon-xs" />
                <template v-for="(segment, index) in pathSegments" :key="index">
                  <span class="path-segment" @click="navigateToPathSegment(index)">{{ segment.name }}</span>
                  <ChevronRightIcon v-if="index < pathSegments.length - 1" class="icon-xs" />
                </template>
              </template>
              <span v-else>ÊàëÁöÑÁΩëÁõò</span>
            </div>
          </div>
          <div class="header-right">
            <button class="icon-btn" @click="openSettings">
              <SettingsIcon class="icon-sm" />
            </button>
          </div>
        </div>

        <div class="toolbar">
          <div class="toolbar-left">
            <button v-if="currentParentId" class="btn-outline" @click="navigateToParent">
              <ArrowLeftIcon class="icon-sm" />
              ËøîÂõû‰∏äÁ∫ß
            </button>
            <button class="btn-primary" @click="createNewFolder">
              <PlusIcon class="icon-sm" />
              Êñ∞Âª∫Êñá‰ª∂Â§π
            </button>
            <button class="btn-outline" @click="openUploadModal">
              <UploadIcon class="icon-sm" />
              ‰∏ä‰º†
            </button>
            <button v-if="selectedFiles.size > 0" class="btn-primary" @click="downloadSelectedFiles">
              <UploadIcon class="icon-sm" transform="rotate(180)" />
              ‰∏ãËΩΩ ({{ selectedFiles.size }})
            </button>
            <button v-if="selectedFiles.size > 0" class="btn-outline" @click="shareSelectedFiles">
              <UploadIcon class="icon-sm" />
              ÂàÜ‰∫´ ({{ selectedFiles.size }})
            </button>
          </div>
          <div class="toolbar-right">
            <div class="search-container">
              <SearchIcon class="search-icon" />
              <input type="text" v-model="searchQuery" placeholder="ÊêúÁ¥¢Êñá‰ª∂..." class="search-input" />
            </div>
          </div>
        </div>

        <div class="file-container">
          <transition name="simple-fade" mode="out-in">
            <div v-if="isLoading" class="loading-container">
              <div class="loading-spinner"></div>
              <p>Âä†ËΩΩ‰∏≠...</p>
            </div>
            <div v-else :key="currentParentId || 'root'" class="file-container-inner">
              <div class="file-grid">
                <div v-for="(file, index) in filteredFiles" :key="file.id || index" class="file-item"
                  :class="{ 
                    'folder-item': file.type === 'folder',
                    'new-uploaded-file': newUploadedFileIds.includes(file.id || ''),
                    'selected': file.id && selectedFiles.has(file.id)
                  }" 
                  @click="handleFileClick(file)"
                  @dblclick="handleFileDoubleClick(file)"
                  @contextmenu.prevent="showContextMenu($event, file)">
                  <div class="file-content">
                    <div class="file-icon-container">
                      <FolderIcon v-if="file.type === 'folder'" class="folder-icon" />
                      <component v-else-if="file.icon" :is="file.icon" :class="[
                        'file-icon',
                        file.type === 'image' ? 'image-icon' : '',
                        file.type === 'video' ? 'video-icon' : '',
                        file.type === 'audio' ? 'audio-icon' : '',
                        file.type === 'code' ? 'code-icon' : '',
                        file.type === 'pdf' ? 'pdf-icon' : '',
                        file.type === 'archive' ? 'archive-icon' : '',
                        file.type === 'spreadsheet' ? 'spreadsheet-icon' : '',
                        file.type === 'presentation' ? 'presentation-icon' : ''
                      ]" />
                      <FileIcon v-else class="file-icon" />
                    </div>
                    <div class="file-info">
                      <p class="file-name" :title="file.name">{{ file.name }}</p>
                      <div class="file-details">
                        <p class="file-size">{{ file.size }}</p>
                        <p class="file-modified" v-if="file.modified">{{ file.modified }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </transition>
        </div>
      </template>
    </div>

    <!-- ËÆæÁΩÆÂºπÁ™ó - ÊåâÈúÄÊòæÁ§∫ -->
    <SettingsModal v-if="showSettingsModal" @close="showSettingsModal = false" />

    <!-- ‰∏ä‰º†ÂºπÁ™ó - ÊåâÈúÄÊòæÁ§∫ -->
    <div v-if="showUploadModal" class="upload-modal-container">
      <div class="upload-modal-overlay" @click="closeUploadModal"></div>
      <UploadModal ref="uploadModalRef" :upload-progress="uploadProgress" @close="closeUploadModal"
        @upload="handleUploadFiles" @retry="handleRetryUpload" />
    </div>

    <!-- ÂàÜ‰∫´ÈìæÊé•ÂºπÁ™ó - ÊåâÈúÄÊòæÁ§∫ -->
    <ShareLinkPopup v-if="showShareLinkPopup" :file="selectedFile" @close="showShareLinkPopup = false" />

    <!-- Êñ∞Âª∫Êñá‰ª∂Â§πÂºπÁ™ó -->
    <div v-if="showNewFolderDialog" class="dialog-overlay" @click.self="cancelDialog">
      <div class="dialog-box">
        <div class="dialog-header">
          <h3>Êñ∞Âª∫Êñá‰ª∂Â§π</h3>
          <button class="close-btn" @click="cancelDialog">√ó</button>
        </div>
        <div class="dialog-body">
          <input type="text" v-model="newFolderName" placeholder="ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞" class="dialog-input" ref="folderNameInput"
            @keyup.enter="confirmNewFolder" />
        </div>
        <div class="dialog-footer">
          <button class="btn-outline" @click="cancelDialog">ÂèñÊ∂à</button>
          <button class="btn-primary" @click="confirmNewFolder">Á°ÆÂÆö</button>
        </div>
      </div>
    </div>

    <!-- ÈáçÂëΩÂêçÂºπÁ™ó -->
    <div v-if="showRenameDialog" class="dialog-overlay" @click.self="cancelDialog">
      <div class="dialog-box">
        <div class="dialog-header">
          <h3>ÈáçÂëΩÂêç</h3>
          <button class="close-btn" @click="cancelDialog">√ó</button>
        </div>
        <div class="dialog-body">
          <div v-if="fileToRename && !fileToRename.type.includes('folder')" class="filename-container">
            <input type="text" v-model="fileNameWithoutExt" placeholder="Êñá‰ª∂Âêç" class="dialog-input filename-input"
              ref="fileNameInput" @keyup.enter="confirmRename" />
            <div class="extension-container">
              <div class="extension-wrapper" @dblclick="enableExtensionEdit" :title="editingExtension ? '' : 'ÂèåÂáªÁºñËæëÂêéÁºÄÂêç'">
                <input type="text" v-model="fileExtension" class="dialog-input extension-input"
                  :disabled="!editingExtension" @keyup.enter="confirmRename" ref="extensionInput" />
              </div>
              <button class="extension-edit-btn" :class="{ 'active': editingExtension }" @click="toggleExtensionEdit"
                :title="editingExtension ? 'ÈîÅÂÆöÂêéÁºÄÂêç' : 'ÁºñËæëÂêéÁºÄÂêç'">
                <span v-if="editingExtension">üîì</span>
                <span v-else>üîí</span>
              </button>
            </div>
          </div>
          <input v-else type="text" v-model="newFileName" placeholder="ËØ∑ËæìÂÖ•Êñ∞ÂêçÁß∞" class="dialog-input"
            ref="folderNameInput" @keyup.enter="confirmRename" />
        </div>
        <div class="dialog-footer">
          <button class="btn-outline" @click="cancelDialog">ÂèñÊ∂à</button>
          <button class="btn-primary" @click="confirmRename">Á°ÆÂÆö</button>
        </div>
      </div>
    </div>

    <!-- Âè≥ÈîÆËèúÂçï -->
    <div v-if="contextMenu.show" class="context-menu" :style="contextMenuStyle">
      <ul>
        <li @click="openFile(contextMenu.file)">
          <FileIcon class="icon-xs" /> ÊâìÂºÄ
        </li>
        <li @click="shareFile(contextMenu.file)">
          <UploadIcon class="icon-xs" /> ÂàÜ‰∫´
        </li>
        <li @click="downloadFile(contextMenu.file)">
          <UploadIcon class="icon-xs" transform="rotate(180)" /> ‰∏ãËΩΩ
        </li>
        <li @click="renameFile(contextMenu.file)">
          <FileTextIcon class="icon-xs" /> ÈáçÂëΩÂêç
        </li>
        <li @click="deleteFile(contextMenu.file)" class="danger">
          <XIcon class="icon-xs" /> Âà†Èô§
        </li>
      </ul>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, nextTick, provide, type ComponentPublicInstance } from 'vue'
import type { FileItem } from '../utils/types/file'
import SettingsModal from '../modals/SettingsModal.vue'
import UploadModal from '../modals/UploadModal.vue'
import ShareLinkPopup from '../modals/ShareLinkPopup.vue'
import MobileView from './MobileView.vue'
import FilePreview from './FilePreview.vue'
import {
  HomeIcon,
  ChevronRightIcon,
  SettingsIcon,
  PlusIcon,
  UploadIcon,
  SearchIcon,
  FolderIcon,
  FileIcon,
  FileTextIcon,
  ImageIcon,
  VideoIcon,
  MusicIcon,
  XIcon,
  ArrowLeftIcon,
  FileCodeIcon,
  FileZipIcon,
  FilePdfIcon,
  FileSpreadsheetIcon,
  FilePresentationIcon,
} from '../utils/icons'
import { listFiles, createFolder, uploadFile, getDownloadUrl, renameFile as apiRenameFile, deleteFile as apiDeleteFile, initChunkUpload, uploadChunk, completeChunkUpload, getUploadedChunks, FileInfo } from '@/api/file'

// Áä∂ÊÄÅÂèòÈáè
const uploadProgress = ref(0)
const currentPath = ref('')
const currentParentId = ref('')
const searchQuery = ref('')
const showSettingsModal = ref(false)
const showUploadModal = ref(false)
const showShareLinkPopup = ref(false)
const isLoading = ref(false)
const selectedFiles = ref<Set<string>>(new Set()) // Â≠òÂÇ®ÈÄâ‰∏≠ÁöÑÊñá‰ª∂ID
// ÂÆö‰πâUploadModalInstanceÁ±ªÂûã
type UploadModalInstance = ComponentPublicInstance & {
  updateFileStatus: (fileIndex: number, status: 'success' | 'error' | 'uploading', message?: string, uploadedChunks?: number, totalChunks?: number) => void
}
// ‰ΩøÁî®Ê≠£Á°ÆÁöÑÁ±ªÂûã
const uploadModalRef = ref<UploadModalInstance | null>(null)
const selectedFile = ref<FileItem>({
  name: '',
  type: 'file',
  size: ''
})
const showFilePreview = ref(false)
const contextMenu = ref({
  show: false,
  x: 0,
  y: 0,
  file: {
    name: '',
    type: 'file',
    size: ''
  } as FileItem
})
const isMobile = ref(false)
const showNewFolderDialog = ref(false)
const showRenameDialog = ref(false)
const newFolderName = ref('Êñ∞Âª∫Êñá‰ª∂Â§π')
const newFileName = ref('')
const fileToRename = ref<FileItem | null>(null)
const fileNameWithoutExt = ref('')
const fileExtension = ref('')
const editingExtension = ref(false)
const folderNameInput = ref<HTMLInputElement | null>(null)
const fileNameInput = ref<HTMLInputElement | null>(null)
const extensionInput = ref<HTMLInputElement | null>(null)

// Ê∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑÁä∂ÊÄÅÊù•Ë∑üË∏™Êñ∞‰∏ä‰º†ÁöÑÊñá‰ª∂ID
const newUploadedFileIds = ref<string[]>([]);

// Ë∑ØÂæÑÂØºËà™ÂéÜÂè≤
interface PathSegment {
  id: string;
  name: string;
}
const pathSegments = ref<PathSegment[]>([])

// ‰∏∫FilePreviewÁªÑ‰ª∂Êèê‰æõË∑ØÂæÑÂØºËà™ÂäüËÉΩ
provide('pathSegments', pathSegments.value)
provide('navigateToRoot', navigateToRoot)
provide('navigateToPathSegment', navigateToPathSegment)

// Êñá‰ª∂Êï∞ÊçÆ
const apiFiles = ref<FileInfo[]>([])

// ÁßªÂä®Á´ØÊñá‰ª∂ÂàóË°®
const mobileFiles = ref<FileItem[]>([])

// Â∞ÜAPIËøîÂõûÁöÑÊñá‰ª∂Êï∞ÊçÆËΩ¨Êç¢‰∏∫ÁªÑ‰ª∂‰ΩøÁî®ÁöÑÊ†ºÂºè
const convertedFiles = computed<FileItem[]>(() => {
  return apiFiles.value.map(file => {
    // Á°ÆÂÆöÊñá‰ª∂ÂõæÊ†á
    let icon;
    let fileType: 'file' | 'folder' | 'image' | 'video' | 'audio' | 'code' | 'pdf' | 'archive' | 'spreadsheet' | 'presentation' | 'text' = file.is_folder ? 'folder' : 'file';

    if (file.is_folder) {
      icon = FolderIcon;
    } else if (file.mimeType) {
      // Ê†πÊçÆMIMEÁ±ªÂûãÁ°ÆÂÆöÂõæÊ†á
      if (file.mimeType.startsWith('image/')) {
        icon = ImageIcon;
        fileType = 'image';
      } else if (file.mimeType.startsWith('video/')) {
        icon = VideoIcon;
        fileType = 'video';
      } else if (file.mimeType.startsWith('audio/')) {
        icon = MusicIcon;
        fileType = 'audio';
      } else if (file.mimeType.startsWith('application/pdf')) {
        icon = FilePdfIcon;
        fileType = 'pdf';
      } else if (
        file.mimeType.includes('zip') ||
        file.mimeType.includes('compressed') ||
        file.mimeType.includes('archive') ||
        file.mimeType.includes('x-tar') ||
        file.mimeType.includes('x-rar')
      ) {
        icon = FileZipIcon;
        fileType = 'archive';
      } else if (
        file.mimeType.includes('excel') ||
        file.mimeType.includes('spreadsheet') ||
        file.mimeType.includes('csv')
      ) {
        icon = FileSpreadsheetIcon;
        fileType = 'spreadsheet';
      } else if (
        file.mimeType.includes('powerpoint') ||
        file.mimeType.includes('presentation')
      ) {
        icon = FilePresentationIcon;
        fileType = 'presentation';
      } else if (
        file.mimeType.includes('javascript') ||
        file.mimeType.includes('json') ||
        file.mimeType.includes('html') ||
        file.mimeType.includes('css') ||
        file.mimeType.includes('xml') ||
        file.mimeType.includes('text/plain') ||
        file.mimeType.includes('text/markdown') ||
        file.mimeType.includes('text/')
      ) {
        // ÊâÄÊúâÊñáÊú¨Á±ªÂûãÊñá‰ª∂ÈÉΩÂΩí‰∏∫textÁ±ªÂûãÔºå‰ª•ÊîØÊåÅÈ¢ÑËßà
        icon = FileCodeIcon;
        fileType = 'text';
      } else {
        icon = FileTextIcon;
      }
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâMIMEÁ±ªÂûãÔºåÂ∞ùËØïÈÄöËøáÊñá‰ª∂Êâ©Â±ïÂêçÂà§Êñ≠
      const extension = file.name.split('.').pop()?.toLowerCase();
      if (extension) {
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(extension)) {
          icon = ImageIcon;
          fileType = 'image';
        } else if (['mp4', 'webm', 'avi', 'mov', 'wmv', 'flv', 'mkv'].includes(extension)) {
          icon = VideoIcon;
          fileType = 'video';
        } else if (['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'].includes(extension)) {
          icon = MusicIcon;
          fileType = 'audio';
        } else if (extension === 'pdf') {
          icon = FilePdfIcon;
          fileType = 'pdf';
        } else if (['zip', 'rar', '7z', 'tar', 'gz', 'bz2'].includes(extension)) {
          icon = FileZipIcon;
          fileType = 'archive';
        } else if (['xls', 'xlsx', 'csv', 'ods'].includes(extension)) {
          icon = FileSpreadsheetIcon;
          fileType = 'spreadsheet';
        } else if (['ppt', 'pptx', 'odp'].includes(extension)) {
          icon = FilePresentationIcon;
          fileType = 'presentation';
        } else if (
          // ÊâÄÊúâÊñáÊú¨Á±ªÂûãÊñá‰ª∂ÂíåÁºñÁ®ãËØ≠Ë®ÄÊñá‰ª∂ÈÉΩÂΩí‰∏∫textÁ±ªÂûãÔºå‰ª•ÊîØÊåÅÈ¢ÑËßà
          ['txt', 'md', 'markdown', 'text', 'log', 'rtf', 'js', 'ts', 'html', 'css', 'xml', 'json', 'py', 'java', 'c', 'cpp', 'go', 'php', 'rb', 'sh', 'bat', 'ps1', 'sql', 'yaml', 'yml', 'toml', 'ini', 'conf', 'config'].includes(extension)
        ) {
          // Ê†πÊçÆÊñá‰ª∂Á±ªÂûã‰ΩøÁî®‰∏çÂêåÁöÑÂõæÊ†áÔºå‰ΩÜÈÉΩÂΩí‰∏∫textÁ±ªÂûã‰ª•ÊîØÊåÅÈ¢ÑËßà
          if (['js', 'ts', 'html', 'css', 'xml', 'json', 'py', 'java', 'c', 'cpp', 'go', 'php', 'rb', 'sh', 'sql', 'yaml', 'yml'].includes(extension)) {
            icon = FileCodeIcon;
          } else {
            icon = FileTextIcon;
          }
          fileType = 'text';
        } else {
          icon = FileTextIcon;
        }
      } else {
        icon = FileTextIcon;
      }
    }

    // Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
    const formatSize = (size: number): string => {
      if (file.is_folder) return 'Êñá‰ª∂Â§π';
      if (size < 1024) return `${size} B`;
      if (size < 1024 * 1024) return `${(size / 1024).toFixed(1)} KB`;
      if (size < 1024 * 1024 * 1024) return `${(size / (1024 * 1024)).toFixed(1)} MB`;
      return `${(size / (1024 * 1024 * 1024)).toFixed(1)} GB`;
    };

    // Ê†ºÂºèÂåñ‰øÆÊîπÊó•Êúü
    const formatDate = (dateStr: string): string => {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    // Á°Æ‰øùÊñá‰ª∂IDÂ≠òÂú®‰∏îËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤
    const fileId = file.id ? file.id.toString() : '';

    return {
      id: fileId, // Á°Æ‰øùIDÂ≠òÂú®‰∏î‰∏∫Â≠óÁ¨¶‰∏≤
      name: file.name,
      type: fileType,
      size: formatSize(file.size),
      modified: formatDate(file.updateTime),
      icon,
      originalFile: file // ‰øùÁïôÂéüÂßãÊï∞ÊçÆÔºå‰ª•‰æøÂêéÁª≠Êìç‰Ωú
    } as FileItem;
  });
});

// ËøáÊª§Êñá‰ª∂ÂàóË°®
const filteredFiles = computed(() => {
  if (!searchQuery.value) return convertedFiles.value;

  const query = searchQuery.value.toLowerCase();
  return convertedFiles.value.filter(file =>
    file.name.toLowerCase().includes(query)
  );
})

// ËÆ°ÁÆóÂè≥ÈîÆËèúÂçï‰ΩçÁΩÆ
const contextMenuStyle = computed(() => {
  return {
    top: `${contextMenu.value.y}px`,
    left: `${contextMenu.value.x}px`
  }
})

// Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
const fetchFiles = async (parentId: string = '') => {
  try {
    isLoading.value = true;
    const response = await listFiles(parentId);
    apiFiles.value = response;
    // Êõ¥Êñ∞ÁßªÂä®Á´ØÊñá‰ª∂ÂàóË°®
    mobileFiles.value = convertedFiles.value;
    isLoading.value = false;
  } catch (error) {
    console.error('Ëé∑ÂèñÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
    ElMessage.error('Ëé∑ÂèñÊñá‰ª∂ÂàóË°®Â§±Ë¥•');
    isLoading.value = false;
  }
};

// Ê£ÄÊµãÁßªÂä®ËÆæÂ§á
function checkMobile() {
  isMobile.value = window.innerWidth < 768;
}

// ÂØºËà™Âà∞Ê†πÁõÆÂΩï
function navigateToRoot() {
  currentPath.value = '';
  currentParentId.value = '';
  pathSegments.value = []; // Ê∏ÖÁ©∫Ë∑ØÂæÑÂØºËà™ÂéÜÂè≤
  fetchFiles();
}

// ÂØºËà™Âà∞ÁâπÂÆöË∑ØÂæÑÊÆµ
function navigateToPathSegment(index: number) {
  if (index < 0 || index >= pathSegments.value.length) return;

  // Ëé∑ÂèñÁõÆÊ†áË∑ØÂæÑÊÆµ
  const targetSegment = pathSegments.value[index];

  // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑÂíåÁà∂ID
  currentParentId.value = targetSegment.id;

  // Êõ¥Êñ∞Ë∑ØÂæÑÊÆµÂéÜÂè≤Ôºà‰øùÁïôÂà∞ÂΩìÂâçÁÇπÂáªÁöÑÊÆµÔºâ
  pathSegments.value = pathSegments.value.slice(0, index + 1);

  // ÈáçÊñ∞ÊûÑÂª∫ÂΩìÂâçË∑ØÂæÑ
  currentPath.value = pathSegments.value.map(segment => segment.name).join('/');

  // Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
  fetchFiles(targetSegment.id);
}

// ÂØºËà™Âà∞‰∏ä‰∏ÄÁ∫ßÁõÆÂΩï
function navigateToParent() {
  if (pathSegments.value.length <= 1) {
    // Â¶ÇÊûúÂè™Êúâ‰∏ÄÁ∫ßÊàñÊ≤°ÊúâÔºåÂàôËøîÂõûÊ†πÁõÆÂΩï
    navigateToRoot();
  } else {
    // Âê¶ÂàôËøîÂõû‰∏ä‰∏ÄÁ∫ß
    const parentIndex = pathSegments.value.length - 2;
    navigateToPathSegment(parentIndex);
  }
}

// ÊâìÂºÄËÆæÁΩÆÂºπÁ™ó
function openSettings() {
  showSettingsModal.value = true;
}

// ÊâìÂºÄ‰∏ä‰º†ÂºπÁ™ó
function openUploadModal() {
  showUploadModal.value = true;
}

// ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
function createNewFolder() {
  showNewFolderDialog.value = true;
  newFolderName.value = 'Êñ∞Âª∫Êñá‰ª∂Â§π';

  // Âú®‰∏ã‰∏Ä‰∏™DOMÊõ¥Êñ∞Âë®ÊúüÂêéËÅöÁÑ¶ËæìÂÖ•Ê°ÜÂπ∂ÈÄâ‰∏≠ÊñáÊú¨
  nextTick(() => {
    if (folderNameInput.value) {
      folderNameInput.value.focus();
      folderNameInput.value.select();
    }
  });
}

// Á°ÆËÆ§ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
async function confirmNewFolder() {
  if (newFolderName.value.trim()) {
    try {
      await createFolder(currentParentId.value, newFolderName.value);
      ElMessage.success('Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü');
      // Âà∑Êñ∞Êñá‰ª∂ÂàóË°®
      fetchFiles(currentParentId.value);
      showNewFolderDialog.value = false;
    } catch (error) {
      console.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
      ElMessage.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•');
    }
  }
}

// ÈáçÂëΩÂêçÊñá‰ª∂
function renameFile(file: FileItem) {
  if (!file.id) return;

  fileToRename.value = file;

  if (file.type !== 'folder') {
    // ÂàÜÁ¶ªÊñá‰ª∂ÂêçÂíåÊâ©Â±ïÂêç
    const lastDotIndex = file.name.lastIndexOf('.');
    if (lastDotIndex > 0) {
      fileNameWithoutExt.value = file.name.substring(0, lastDotIndex);
      fileExtension.value = file.name.substring(lastDotIndex);
    } else {
      fileNameWithoutExt.value = file.name;
      fileExtension.value = '';
    }
    newFileName.value = file.name;
    editingExtension.value = false;
  } else {
    newFileName.value = file.name;
  }

  showRenameDialog.value = true;
  closeContextMenu();

  // Âú®‰∏ã‰∏Ä‰∏™DOMÊõ¥Êñ∞Âë®ÊúüÂêéËÅöÁÑ¶ËæìÂÖ•Ê°ÜÂπ∂ÈÄâ‰∏≠ÊñáÊú¨
  nextTick(() => {
    if (file.type !== 'folder' && fileNameInput.value) {
      fileNameInput.value.focus();
      fileNameInput.value.select();
    } else if (folderNameInput.value) {
      folderNameInput.value.focus();
      folderNameInput.value.select();
    }
  });
}

// ÂàáÊç¢Êâ©Â±ïÂêçÁºñËæëÁä∂ÊÄÅ
function toggleExtensionEdit() {
  editingExtension.value = !editingExtension.value;

  // Â¶ÇÊûúÂêØÁî®‰∫ÜÊâ©Â±ïÂêçÁºñËæëÔºåËÅöÁÑ¶Âà∞Êâ©Â±ïÂêçËæìÂÖ•Ê°Ü
  if (editingExtension.value) {
    nextTick(() => {
      const extensionInput = document.querySelector('.extension-input') as HTMLInputElement;
      if (extensionInput) {
        extensionInput.focus();
        extensionInput.select();
      }
    });
  }
}

// ÂêØÁî®Êâ©Â±ïÂêçÁºñËæëÔºàÂèåÂáªÊó∂Ë∞ÉÁî®Ôºâ
function enableExtensionEdit(event: MouseEvent) {
  // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈò≤Ê≠¢Ëß¶ÂèëÂÖ∂‰ªñÁÇπÂáª‰∫ã‰ª∂
  event.stopPropagation();

  if (!editingExtension.value) {
    editingExtension.value = true;

    // Âª∂Ëøü‰∏Ä‰∏ãÂÜçËÅöÁÑ¶ÔºåÁ°Æ‰øùÁ¶ÅÁî®Áä∂ÊÄÅÂ∑≤ÁªèËß£Èô§
    nextTick(() => {
      if (extensionInput.value) {
        extensionInput.value.disabled = false;
        extensionInput.value.focus();
        extensionInput.value.select();
      }
    });
  }
}

// Á°ÆËÆ§ÈáçÂëΩÂêç
async function confirmRename() {
  // ÊûÑÂª∫ÂÆåÊï¥ÁöÑÊñ∞Êñá‰ª∂Âêç
  if (fileToRename.value && fileToRename.value.type !== 'folder') {
    newFileName.value = fileNameWithoutExt.value + fileExtension.value;
  }

  if (fileToRename.value && fileToRename.value.id && newFileName.value.trim() && newFileName.value !== fileToRename.value.name) {
    try {
      await apiRenameFile(fileToRename.value.id, newFileName.value);
      ElMessage.success('ÈáçÂëΩÂêçÊàêÂäü');
      fetchFiles(currentParentId.value);
      showRenameDialog.value = false;
    } catch (error) {
      console.error('ÈáçÂëΩÂêçÂ§±Ë¥•:', error);
      ElMessage.error('ÈáçÂëΩÂêçÂ§±Ë¥•');
    }
  } else if (newFileName.value === fileToRename.value?.name) {
    showRenameDialog.value = false;
  }
}

// ÂèñÊ∂àÂØπËØùÊ°Ü
function cancelDialog() {
  showNewFolderDialog.value = false;
  showRenameDialog.value = false;
}

// Â§ÑÁêÜÊñá‰ª∂ÂçïÂáªÔºàÈÄâÊã©Êñá‰ª∂Ôºâ
function handleFileClick(file: FileItem) {
  if (file.id) {
    if (selectedFiles.value.has(file.id)) {
      selectedFiles.value.delete(file.id);
    } else {
      selectedFiles.value.add(file.id);
    }
  }
}

// Â§ÑÁêÜÊñá‰ª∂ÂèåÂáªÔºàÊâìÂºÄÊñá‰ª∂ÊàñËøõÂÖ•Êñá‰ª∂Â§πÔºâ
function handleFileDoubleClick(file: FileItem) {
  // ÂèåÂáªÊó∂Ê∏ÖÁ©∫ÈÄâÊã©Áä∂ÊÄÅ
  selectedFiles.value.clear();
  
  if (file.type === 'folder') {
    // Â¶ÇÊûúÊòØÊñá‰ª∂Â§πÔºåËøõÂÖ•ËØ•Êñá‰ª∂Â§π
    const folderId = file.id as string;
    currentParentId.value = folderId;

    // Êõ¥Êñ∞Ë∑ØÂæÑÂØºËà™ÂéÜÂè≤
    pathSegments.value.push({
      id: folderId,
      name: file.name
    });

    // Êõ¥Êñ∞ÂΩìÂâçË∑ØÂæÑ
    currentPath.value = pathSegments.value.map(segment => segment.name).join('/');

    // Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
    fetchFiles(folderId);
  } else {
    // Â¶ÇÊûúÊòØÊñá‰ª∂ÔºåÊâìÂºÄÈ¢ÑËßà
    selectedFile.value = file;
    showFilePreview.value = true;
  }
}

// ÂÖ≥Èó≠Êñá‰ª∂È¢ÑËßà
function closeFilePreview() {
  showFilePreview.value = false;
}

// Â§ÑÁêÜÁßªÂä®Á´ØÊñá‰ª∂ÊâìÂºÄ
function handleMobileFileOpen(file: FileItem) {
  handleFileClick(file);
}

// Â§ÑÁêÜÁßªÂä®Á´ØÈáçÂëΩÂêç
function handleMobileRename(file: FileItem) {
  renameFile(file);
}

// ÊâìÂºÄÊñá‰ª∂
function openFile(file: FileItem) {
  handleFileClick(file);
  closeContextMenu();
}

// ÂàÜ‰∫´Êñá‰ª∂
function shareFile(file: FileItem) {
  selectedFile.value = file;
  showShareLinkPopup.value = true;
  closeContextMenu();
}

// ‰∏ãËΩΩÊñá‰ª∂
function downloadFile(file: FileItem) {
  if (file.type === 'file' && file.id) {
    const downloadUrl = getDownloadUrl(file.id);
    window.open(downloadUrl, '_blank');
  }
  closeContextMenu();
}

// ÊâπÈáè‰∏ãËΩΩÈÄâ‰∏≠ÁöÑÊñá‰ª∂
function downloadSelectedFiles() {
  if (selectedFiles.value.size === 0) {
    ElMessage.warning('ËØ∑ÂÖàÈÄâÊã©Ë¶Å‰∏ãËΩΩÁöÑÊñá‰ª∂');
    return;
  }

  const selectedFileItems = filteredFiles.value.filter(file => 
    file.id && selectedFiles.value.has(file.id) && file.type === 'file'
  );

  if (selectedFileItems.length === 0) {
    ElMessage.warning('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÊñá‰ª∂');
    return;
  }

  // ÈÄê‰∏™‰∏ãËΩΩÊâÄÊúâÈÄâ‰∏≠ÁöÑÊñá‰ª∂
  selectedFileItems.forEach(file => {
    if (file.type === 'file' && file.id) {
      const downloadUrl = getDownloadUrl(file.id);
      window.open(downloadUrl, '_blank');
    }
  });

  // ‰∏ãËΩΩÂÆåÊàêÂêéÊ∏ÖÁ©∫ÈÄâÊã©
  selectedFiles.value.clear();
}

// ÊâπÈáèÂàÜ‰∫´ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
function shareSelectedFiles() {
  if (selectedFiles.value.size === 0) {
    ElMessage.warning('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂàÜ‰∫´ÁöÑÊñá‰ª∂');
    return;
  }

  const selectedFileItems = filteredFiles.value.filter(file => 
    file.id && selectedFiles.value.has(file.id)
  );

  if (selectedFileItems.length === 0) {
    ElMessage.warning('Ê≤°ÊúâÈÄâÊã©ÊúâÊïàÁöÑÊñá‰ª∂');
    return;
  }

  if (selectedFileItems.length > 1) {
    ElMessage.warning('ÊöÇ‰∏çÊîØÊåÅÊâπÈáèÂàÜ‰∫´Â§ö‰∏™Êñá‰ª∂');
    return;
  }

  // ÂàÜ‰∫´Âçï‰∏™Êñá‰ª∂
  const file = selectedFileItems[0];
  selectedFile.value = file;
  showShareLinkPopup.value = true;
  
  // ÂàÜ‰∫´ÂêéÊ∏ÖÁ©∫ÈÄâÊã©
  selectedFiles.value.clear();
}

// Âà†Èô§Êñá‰ª∂
function deleteFile(file: FileItem) {
  if (!file.id) return;

  if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ ${file.name} ÂêóÔºü`)) {
    apiDeleteFile(file.id)
      .then(() => {
        ElMessage.success('Âà†Èô§ÊàêÂäü');
        fetchFiles(currentParentId.value);
      })
      .catch((error: any) => {
        console.error('Âà†Èô§Â§±Ë¥•:', error);
        ElMessage.error('Âà†Èô§Â§±Ë¥•');
      });
  }
  closeContextMenu();
}

// ÊòæÁ§∫‰∏ä‰∏ãÊñáËèúÂçï
function showContextMenu(event: MouseEvent, file: FileItem) {
  event.preventDefault();
  contextMenu.value.show = true;
  contextMenu.value.x = event.clientX;
  contextMenu.value.y = event.clientY;
  contextMenu.value.file = file;

  // Ê∑ªÂä†ÂÖ®Â±ÄÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÁî®‰∫éÂÖ≥Èó≠‰∏ä‰∏ãÊñáËèúÂçï
  document.addEventListener('click', closeContextMenu);
}

// ÂÖ≥Èó≠‰∏ä‰∏ãÊñáËèúÂçï
function closeContextMenu() {
  contextMenu.value.show = false;
  document.removeEventListener('click', closeContextMenu);
}

// Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º†
async function handleUploadFiles(files: File[]) {
  if (!files.length) return;

  // Ëé∑ÂèñÊòØÂê¶ÂêØÁî®Êñ≠ÁÇπÁª≠‰º†ÁöÑËÆæÁΩÆ
    const enableResumeUpload = (uploadModalRef.value as any)?.enableResumeUpload ?? true;

  let successCount = 0;
  let failCount = 0;
  const totalFiles = files.length;
  // Ê∏ÖÁ©∫Êñ∞‰∏ä‰º†Êñá‰ª∂IDÂàóË°®
  newUploadedFileIds.value = [];

  // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
  uploadProgress.value = 0;
  
  for (let i = 0; i < totalFiles; i++) {
    const file = files[i];
    
    try {
      // ÊâÄÊúâÊñá‰ª∂ÈÉΩ‰ΩøÁî®ÂàÜÁâá‰∏ä‰º†Êé•Âè£
      await uploadLargeFile(file, i);
      successCount++;
    } catch (error) {
      // Âçï‰∏™Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•ÔºåËÆ∞ÂΩï‰ΩÜ‰∏ç‰∏≠Êñ≠ÂÖ∂‰ªñÊñá‰ª∂‰∏ä‰º†
      console.error(`Êñá‰ª∂ "${file.name}" ‰∏ä‰º†Â§±Ë¥•:`, error);
      // Êõ¥Êñ∞Êñá‰ª∂Áä∂ÊÄÅ‰∏∫Â§±Ë¥•
      uploadModalRef.value?.updateFileStatus(i, 'error', error instanceof Error ? error.message : '‰∏ä‰º†Â§±Ë¥•');
      failCount++;
    }
    
    // Êõ¥Êñ∞ÊÄªËøõÂ∫¶
    uploadProgress.value = Math.round(((i + 1) / totalFiles) * 100);
  }

  // ÊâÄÊúâÊñá‰ª∂‰∏ä‰º†ÂÆåÊàêÂêéÔºåÂè™ÊòæÁ§∫‰∏Ä‰∏™ÊÄªÁªìÊèêÁ§∫
  if (failCount === 0) {
    ElMessage.success(`ÂÖ®ÈÉ® ${successCount} ‰∏™Êñá‰ª∂‰∏ä‰º†ÊàêÂäü`);
  } else if (successCount === 0) {
    ElMessage.error(`ÂÖ®ÈÉ® ${failCount} ‰∏™Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•`);
  } else {
    ElMessage.warning(`‰∏ä‰º†ÂÆåÊàê: ${successCount} ‰∏™ÊàêÂäü, ${failCount} ‰∏™Â§±Ë¥•`);
  }

  // ÈáçÊñ∞Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
  fetchFiles(currentParentId.value);
  
  // ‰∏çÂÜçËá™Âä®Ê∏ÖÈô§È´ò‰∫ÆÊïàÊûú
  // Áî®Êà∑ÂèØ‰ª•ÈÄöËøáÂà∑Êñ∞È°µÈù¢ÊàñÂØºËà™Âà∞ÂÖ∂‰ªñÁõÆÂΩïÊù•Ê∏ÖÈô§È´ò‰∫Æ
}

// Â§ÑÁêÜÂ§ßÊñá‰ª∂ÂàÜÁâá‰∏ä‰º†
async function uploadLargeFile(file: File, fileIndex: number) {
  const chunkSize = 5 * 1024 * 1024; // 5MBÂàÜÁâáÂ§ßÂ∞è
  const totalChunks = Math.ceil(file.size / chunkSize);
  
  try {
    // Ëé∑ÂèñÊòØÂê¶ÂêØÁî®Êñ≠ÁÇπÁª≠‰º†ÁöÑËÆæÁΩÆ
    const enableResumeUpload = (uploadModalRef.value as any)?.enableResumeUpload ?? true;
    
    // Â¶ÇÊûú‰∏çÂêØÁî®Êñ≠ÁÇπÁª≠‰º†ÔºåÁõ¥Êé•‰ΩøÁî®ÊôÆÈÄö‰∏ä‰º†
    if (!enableResumeUpload) {
      const response = await uploadFile(currentParentId.value, file);
      if (response && response.id) {
        newUploadedFileIds.value.push(response.id.toString());
      }
      uploadModalRef.value?.updateFileStatus(fileIndex, 'success', undefined, 1, 1);
      return;
    }
    
    // Êñá‰ª∂Â§ßÂ∞èÊ£ÄÊü•ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ∫¢Âá∫
    const MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024; // 2GBÈôêÂà∂
    if (file.size > MAX_FILE_SIZE) {
      throw new Error(`Êñá‰ª∂Â§ßÂ∞èË∂ÖËøáÈôêÂà∂ (${MAX_FILE_SIZE / 1024 / 1024 / 1024}GB)`);
    }
    
    // ÁîüÊàêÂü∫‰∫éÊñá‰ª∂ÂêçÁöÑÁ®≥ÂÆöuploadIdÔºåÊîØÊåÅÊñ≠ÁÇπÁª≠‰º†
    const stableUploadId = `upload_${currentParentId.value || 'root'}_${file.name}_${file.size}`;
    
    // Â∞ùËØïËé∑ÂèñÂ∑≤Â≠òÂú®ÁöÑ‰∏ä‰º†‰ºöËØù
    let uploadId = stableUploadId;
    let existingSession = false;
    let initResponse;
    
    try {
      const chunksResponse = await getUploadedChunks(stableUploadId);
      if (chunksResponse.totalChunks > 0) {
        initResponse = {
          uploadId: stableUploadId,
          chunkSize: chunkSize,
          totalChunks: totalChunks,
          fileName: file.name,
          fileSize: file.size,
          parentId: currentParentId.value
        };
        existingSession = true;
        console.log('ÊâæÂà∞Â∑≤Â≠òÂú®ÁöÑ‰∏ä‰º†‰ºöËØùÔºåÁªßÁª≠Êñ≠ÁÇπÁª≠‰º†');
      } else {
        // ‰ºöËØùÂ≠òÂú®‰ΩÜÊ≤°ÊúâÂàÜÁâáÔºåËßÜ‰∏∫Êñ∞‰ºöËØù
        initResponse = await initChunkUpload(currentParentId.value, file.name, file.size, chunkSize, stableUploadId);
        uploadId = initResponse.uploadId;
      }
    } catch (error: any) {
      // ‰ºöËØù‰∏çÂ≠òÂú®ÊàñÂÖ∂‰ªñÈîôËØØÔºåÈùôÈªòÂàõÂª∫Êñ∞ÁöÑ‰∏ä‰º†‰ºöËØù
      if (error?.response?.data?.error !== '‰∏ä‰º†‰ºöËØù‰∏çÂ≠òÂú®') {
        console.warn('Ëé∑Âèñ‰∏ä‰º†‰ºöËØù‰ø°ÊÅØÂ§±Ë¥•:', error);
      }
      initResponse = await initChunkUpload(currentParentId.value, file.name, file.size, chunkSize, stableUploadId);
      uploadId = initResponse.uploadId;
    }
    
    // Ëé∑ÂèñÂ∑≤‰∏ä‰º†ÁöÑÂàÜÁâáÂàóË°®ÔºàÊñ≠ÁÇπÁª≠‰º†Ôºâ
    let uploadedChunks: number[] = [];
    try {
      const chunksResponse = await getUploadedChunks(uploadId);
      uploadedChunks = chunksResponse.chunks || [];
    } catch (error: any) {
      // ÈùôÈªòÂ§ÑÁêÜ‰ºöËØù‰∏çÂ≠òÂú®ÁöÑÈîôËØØÔºåËøôÊòØÈ¢ÑÊúüË°å‰∏∫
      if (error?.response?.data?.error !== '‰∏ä‰º†‰ºöËØù‰∏çÂ≠òÂú®') {
        console.warn('Ëé∑ÂèñÂ∑≤‰∏ä‰º†ÂàÜÁâáÂàóË°®Â§±Ë¥•:', error);
      }
      uploadedChunks = [];
    }
    
    // ËÆ°ÁÆóÈúÄË¶Å‰∏ä‰º†ÁöÑÂàÜÁâá
    const pendingChunks = [];
    for (let i = 0; i < totalChunks; i++) {
      if (!uploadedChunks.includes(i)) {
        pendingChunks.push(i);
      }
    }
    
    // Â¶ÇÊûúÊâÄÊúâÂàÜÁâáÈÉΩÂ∑≤‰∏ä‰º†ÔºåÁõ¥Êé•ÂÆåÊàê‰∏ä‰º†
    if (pendingChunks.length === 0) {
      const completeResponse = await completeChunkUpload(uploadId);
      if (completeResponse && completeResponse.id) {
        newUploadedFileIds.value.push(completeResponse.id.toString());
      }
      uploadModalRef.value?.updateFileStatus(fileIndex, 'success');
      return;
    }
    
    // Êõ¥Êñ∞‰∏ä‰º†Áä∂ÊÄÅ
    const uploadedCount = uploadedChunks.length;
    uploadModalRef.value?.updateFileStatus(fileIndex, 'uploading', 
      `Êñ≠ÁÇπÁª≠‰º† (${uploadedCount}/${totalChunks}Â∑≤‰∏ä‰º†ÔºåÂâ©‰Ωô${pendingChunks.length}‰∏™)`,
      uploadedCount, totalChunks);
    
    // ‰∏ä‰º†Êú™ÂÆåÊàêÁöÑÂàÜÁâá
    let completedCount = 0;
    
    // Ëé∑ÂèñÁî®Êà∑ÈÖçÁΩÆÁöÑÈáçËØïÊ¨°Êï∞
    const maxRetries = (uploadModalRef.value as any)?.maxRetries ?? 0;
    
    // ÂàÜÊâπÂ§ÑÁêÜÔºåÈÅøÂÖçÂÜÖÂ≠òÊ∫¢Âá∫
    const BATCH_SIZE = 10; // ÊØèÊâπÂ§ÑÁêÜ10‰∏™ÂàÜÁâá
    const CHUNK_DELAY = 10; // ÂàÜÁâáÈó¥Âª∂Ëøü10msÔºåÂáèÂ∞ëCPUÂç†Áî®
    
    // Â∏¶ÈáçËØïÁöÑÂàÜÁâá‰∏ä‰º†ÂáΩÊï∞
    const uploadChunkWithRetry = async (chunkIndex: number, chunk: Blob) => {
      let retryCount = 0;
      const isInfiniteRetry = maxRetries === 0;
      
      while (isInfiniteRetry || retryCount < maxRetries) {
        try {
          await uploadChunk(uploadId, chunkIndex, chunk);
          return; // ‰∏ä‰º†ÊàêÂäüÔºåÈÄÄÂá∫ÈáçËØïÂæ™ÁéØ
        } catch (error) {
          retryCount++;
          
          if (!isInfiniteRetry && retryCount >= maxRetries) {
            // Ë∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞ÔºåÊäõÂá∫ÈîôËØØ
            throw new Error(`ÂàÜÁâá ${chunkIndex + 1} ‰∏ä‰º†Â§±Ë¥•ÔºåÂ∑≤ÈáçËØï ${maxRetries} Ê¨°: ${error instanceof Error ? error.message : 'Êú™Áü•ÈîôËØØ'}`);
          }
          
          // ËÆ∞ÂΩïÈáçËØï‰ø°ÊÅØ
          const retryInfo = isInfiniteRetry 
            ? `Á¨¨ ${retryCount} Ê¨°ÈáçËØï` 
            : `Á¨¨ ${retryCount}/${maxRetries} Ê¨°ÈáçËØï`;
          console.warn(`ÂàÜÁâá ${chunkIndex + 1} ‰∏ä‰º†Â§±Ë¥•Ôºå${3}ÁßíÂêé${retryInfo}:`, error);
          
          // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫ÈáçËØï‰ø°ÊÅØ
          uploadModalRef.value?.updateFileStatus(fileIndex, 'uploading', 
            `ÂàÜÁâá ${chunkIndex + 1} ‰∏ä‰º†Â§±Ë¥•Ôºå${3}ÁßíÂêéÈáçËØï (${retryInfo})`,
            uploadedCount + completedCount, totalChunks);
          
          // Á≠âÂæÖ3ÁßíÂêéÈáçËØï
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
      }
    };
    
    // ÂàÜÊâπÂ§ÑÁêÜÂàÜÁâá‰∏ä‰º†
    for (let batchStart = 0; batchStart < pendingChunks.length; batchStart += BATCH_SIZE) {
      const batchEnd = Math.min(batchStart + BATCH_SIZE, pendingChunks.length);
      const batchChunks = pendingChunks.slice(batchStart, batchEnd);
      
      // Â§ÑÁêÜÂΩìÂâçÊâπÊ¨°
      await Promise.all(batchChunks.map(async (chunkIndex) => {
        // ‰ΩøÁî®requestIdleCallbackÊàñsetTimeoutÂª∂ËøüÂ§ÑÁêÜÔºåÈÅøÂÖçÈòªÂ°û‰∏ªÁ∫øÁ®ã
        await new Promise(resolve => {
          setTimeout(() => {
            const start = chunkIndex * chunkSize;
            const end = Math.min(start + chunkSize, file.size);
            const chunk = file.slice(start, end);
            resolve(chunk);
          }, CHUNK_DELAY);
        });
        
        const start = chunkIndex * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const chunk = file.slice(start, end);
        
        await uploadChunkWithRetry(chunkIndex, chunk);
        completedCount++;
        
        // Êõ¥Êñ∞ËøõÂ∫¶
        const totalUploaded = uploadedCount + completedCount;
        const progress = Math.round((totalUploaded / totalChunks) * 100);
        uploadModalRef.value?.updateFileStatus(fileIndex, 'uploading', 
          `Êñ≠ÁÇπÁª≠‰º†‰∏≠ (${totalUploaded}/${totalChunks}) ${progress}%`,
          totalUploaded, totalChunks);
        
        // ÊØè‰∏ä‰º†ÂÆå‰∏Ä‰∏™ÂàÜÁâáÔºåËÆ©Âá∫ÊéßÂà∂ÊùÉÁªôÊµèËßàÂô®
        await new Promise(resolve => setTimeout(resolve, 1));
      }));
      
      // ÊâπÊ¨°Èó¥Âª∂ËøüÔºåÁªôÊµèËßàÂô®ÂñòÊÅØÊó∂Èó¥
      if (batchEnd < pendingChunks.length) {
        await new Promise(resolve => setTimeout(resolve, 50));
      }
    }
    
    // ÂÆåÊàêÂàÜÁâá‰∏ä‰º†
    const completeResponse = await completeChunkUpload(uploadId);
    
    // Â¶ÇÊûú‰∏ä‰º†ÊàêÂäüÔºåËÆ∞ÂΩïÊñá‰ª∂ID
    if (completeResponse && completeResponse.id) {
      newUploadedFileIds.value.push(completeResponse.id.toString());
    }
    
    // Êõ¥Êñ∞Áä∂ÊÄÅ‰∏∫ÊàêÂäü
    uploadModalRef.value?.updateFileStatus(fileIndex, 'success');
  } catch (error) {
    console.error('ÂàÜÁâá‰∏ä‰º†Â§±Ë¥•:', error);
    // ‰∏ä‰º†Â§±Ë¥•Ôºå‰∏çËá™Âä®ÂèñÊ∂àÔºåÂÖÅËÆ∏Áî®Êà∑ÈáçËØï
    throw error;
  }
}

// Â§ÑÁêÜÈáçËØï‰∏ä‰º†
async function handleRetryUpload(failedFiles: File[]) {
  if (!failedFiles.length) return;
  
  await handleUploadFiles(failedFiles);
}

// ‰øÆÊîπcloseUploadModalÂáΩÊï∞
function closeUploadModal() {
  // ÂßãÁªàÂÖÅËÆ∏ÂÖ≥Èó≠‰∏ä‰º†ÂºπÁ™ó
  showUploadModal.value = false;
}

onMounted(() => {
  checkMobile();
  window.addEventListener('resize', checkMobile);
  // ÂàùÂßãÂåñÊó∂Ëé∑ÂèñÊñá‰ª∂ÂàóË°®
  fetchFiles();
})

onUnmounted(() => {
  window.removeEventListener('resize', checkMobile);
})
</script>

<style lang="less">
.web-drive-container {
  padding: 20px;
  height: 100%;
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 40px);
  /* ÂáèÂéªpaddingÁöÑÈ´òÂ∫¶ */
  background-color: #ffffff;

  .desktop-view {
    display: flex;
    flex-direction: column;
    height: 100%;
    flex: 1;
    background-color: #ffffff;
  }

  .browser-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-shrink: 0;

    .header-left {
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        background-color: #f8f9fa;
        padding: 10px 16px;
        border-radius: 50px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);

        .icon-sm {
          cursor: pointer;
          color: #666;

          &:hover {
            color: #2a8aff;
          }
        }

        .path-segment {
          cursor: pointer;
          color: #666;
          font-weight: 500;
          padding: 2px 8px;
          border-radius: 4px;
          transition: all 0.2s ease;

          &:hover {
            color: #2a8aff;
            background-color: rgba(42, 138, 255, 0.1);
            text-decoration: none;
          }
        }

        .icon-xs {
          color: #aaa;
        }
      }
    }

    .header-right {
      display: flex;
      gap: 10px;

      .icon-btn {
        background: none;
        border: none;
        padding: 8px;
        cursor: pointer;
        border-radius: 50%;
        transition: all 0.2s ease;

        &.active {
          background-color: #e6f0ff;
          color: #2a8aff;
        }

        &:hover {
          background-color: #f0f5ff;
          transform: translateY(-2px);
        }

        .icon-sm {
          width: 20px;
          height: 20px;
        }
      }
    }
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-shrink: 0;

    .toolbar-left {
      display: flex;
      gap: 10px;

      button {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;

        .icon-sm {
          width: 16px;
          height: 16px;
        }
      }

      .btn-primary {
        background-color: #2a8aff;
        color: white;
        border: none;

        &:hover {
          background-color: #1a7aef;
        }
      }

      .btn-outline {
        background-color: white;
        color: #666;
        border: 1px solid #ddd;

        &:hover {
          background-color: #f5f5f5;
        }
      }
    }

    .toolbar-right {
      .search-container {
        position: relative;

        .search-icon {
          position: absolute;
          left: 10px;
          top: 50%;
          transform: translateY(-50%);
          width: 16px;
          height: 16px;
          color: #999;
        }

        .search-input {
          padding: 8px 10px 8px 35px;
          border: 1px solid #ddd;
          border-radius: 4px;
          width: 250px;
          font-size: 14px;

          &:focus {
            outline: none;
            border-color: #2a8aff;
          }
        }
      }
    }
  }

  .file-container {
      flex: 1;
      overflow: visible; /* ‰øÆÊîπ‰∏∫visibleÔºåÁ°Æ‰øùÂ≠êÂÖÉÁ¥†‰∏çË¢´Ë£ÅÂâ™ */
      display: flex;
      flex-direction: column;
      min-height: 400px;
      /* ÊúÄÂ∞èÈ´òÂ∫¶ÔºåÁ°Æ‰øùÂú®ÂÜÖÂÆπÂ∞ëÊó∂‰πüÊúâ‰∏ÄÂÆöÈ´òÂ∫¶ */
      background-color: #ffffff;
      padding: 10px; /* Ê∑ªÂä†ÂÜÖËæπË∑ùÔºå‰∏∫Ê∫¢Âá∫ÁöÑÂÖÉÁ¥†ÁïôÂá∫Á©∫Èó¥ */

      .file-container-inner {
        display: flex;
        flex-direction: column;
        overflow: visible; /* Á°Æ‰øùÂ≠êÂÖÉÁ¥†‰∏çË¢´Ë£ÅÂâ™ */
      }

      .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));
        gap: 15px; /* Â¢ûÂä†Èó¥Ë∑ùÔºå‰∏∫Ê†áËÆ∞ÁïôÂá∫Êõ¥Â§öÁ©∫Èó¥ */
        flex: 1;
        background-color: #ffffff;
        overflow: visible; /* Á°Æ‰øùÂ≠êÂÖÉÁ¥†‰∏çË¢´Ë£ÅÂâ™ */
        padding: 10px; /* Ê∑ªÂä†ÂÜÖËæπË∑ùÔºå‰∏∫Ê∫¢Âá∫ÁöÑÂÖÉÁ¥†ÁïôÂá∫Á©∫Èó¥ */

      .file-item {
        cursor: pointer;
        border-radius: 8px;
        padding: 15px;
        transition: all 0.3s ease;
        position: relative;
        /* ÁßªÈô§overflow: hiddenÔºåËøôÊòØÂØºËá¥È´ò‰∫ÆÊïàÊûúË¢´ÂàáÊñ≠ÁöÑÂéüÂõ† */
        height: 140px;
        /* Âõ∫ÂÆöÈ´òÂ∫¶ */
        display: flex;
        background-color: #ffffff;
        border: 2px solid transparent;

        &:hover {
          background-color: #f5f5f5;
          transform: translateY(-3px);
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        &.selected {
          background-color: #e6f0ff;
          border-color: #2a8aff;
          box-shadow: 0 5px 15px rgba(42, 138, 255, 0.2);
        }

        &.folder-item {
          &:hover {
            .file-icon-container {
              .folder-icon {
                transform: scale(1.1);
              }
            }
          }
        }

        &.new-uploaded-file {
          animation: highlight-pulse 2s ease-in-out infinite;
          background-color: rgba(59, 130, 246, 0.1);
          border: 1px solid rgba(59, 130, 246, 0.4);
          box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
        }

        .file-content {
          display: flex;
          flex-direction: column;
          align-items: center;
          height: 100%;
          width: 100%;

          .file-icon-container {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;

            .folder-icon,
            .file-icon {
              width: 40px;
              height: 40px;
              transition: transform 0.3s ease;
            }

            .folder-icon {
              color: #2a8aff;
            }

            .file-icon {
              color: #2a8aff;

              &.image-icon {
                color: #4CAF50;
                /* ÁªøËâ≤ */
              }

              &.video-icon {
                color: #FF5722;
                /* Ê©ôÁ∫¢Ëâ≤ */
              }

              &.audio-icon {
                color: #9C27B0;
                /* Á¥´Ëâ≤ */
              }

              &.code-icon {
                color: #607D8B;
                /* ËìùÁÅ∞Ëâ≤ */
              }

              &.pdf-icon {
                color: #F44336;
                /* Á∫¢Ëâ≤ */
              }

              &.archive-icon {
                color: #795548;
                /* Ê£ïËâ≤ */
              }

              &.spreadsheet-icon {
                color: #4CAF50;
                /* ÁªøËâ≤ */
              }

              &.presentation-icon {
                color: #FF9800;
                /* Ê©ôËâ≤ */
              }
            }
          }

          .file-info {
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 50px;

            .file-name {
              font-size: 14px;
              margin: 0 0 3px 0;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              max-width: 100%;
              line-height: 1.2;
            }

            .file-details {
              height: 30px;

              .file-size,
              .file-modified {
                font-size: 12px;
                color: #999;
                margin: 0;
                line-height: 1.2;
              }
            }
          }
        }
      }
    }
  }

  .context-menu {
    position: fixed;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;

    ul {
      list-style: none;
      padding: 0;
      margin: 0;

      li {
        padding: 10px 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;

        &:hover {
          background-color: #f5f5f5;
        }

        &.danger {
          color: #ff4d4f;
        }

        .icon-xs {
          width: 14px;
          height: 14px;
        }
      }
    }
  }
}

// ÁÆÄÂçïÁöÑÊ∑°ÂÖ•Ê∑°Âá∫ÊïàÊûú
.simple-fade-enter-active,
.simple-fade-leave-active {
  transition: opacity 0.25s ease;
}

.simple-fade-enter-from,
.simple-fade-leave-to {
  opacity: 0;
}

// ÂõæÊ†áÂ∞∫ÂØ∏
.icon-xs {
  width: 12px;
  height: 12px;
}

.icon-sm {
  width: 16px;
  height: 16px;
}

// Âä†ËΩΩÂä®Áîª
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  min-height: 300px;
  flex: 1;

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #2a8aff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }

  p {
    color: #666;
    font-size: 14px;
  }
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

// ÂØπËØùÊ°ÜÊ†∑Âºè
.dialog-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1100;
}

.dialog-box {
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  width: 400px;
  max-width: 90%;
  overflow: hidden;
  animation: dialog-appear 0.2s ease-out;

  .dialog-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid #eee;

    h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
      color: #333;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: #999;
      cursor: pointer;
      padding: 0;

      &:hover {
        color: #666;
      }
    }
  }

  .dialog-body {
    padding: 20px;

    .filename-container {
      display: flex;
      align-items: center;
      gap: 5px;
      width: 100%;

      .filename-input {
        flex: 1;
      }

      .extension-container {
        display: flex;
        align-items: center;
        position: relative;

        .extension-wrapper {
          width: 80px;
          cursor: pointer;
        }

        .extension-input {
          width: 100%;
          background-color: #f8f8f8;
          color: #666;

          &:disabled {
            cursor: pointer;
            /* Êîπ‰∏∫ÊåáÈíàÔºåÊèêÁ§∫ÂèØ‰ª•‰∫§‰∫í */
            opacity: 0.8;
            pointer-events: none;
            /* Á¶ÅÁî®‰∫ã‰ª∂ÔºåËÆ©Áà∂ÂÖÉÁ¥†Â§ÑÁêÜÂèåÂáª */
          }

          &:not(:disabled) {
            background-color: #fff;
            color: #333;
          }
        }

        .extension-edit-btn {
          position: absolute;
          right: 8px;
          background: none;
          border: none;
          cursor: pointer;
          padding: 0;
          font-size: 14px;
          color: #999;
          display: flex;
          align-items: center;
          justify-content: center;

          &.active {
            color: #2a8aff;
          }

          &:hover {
            color: #666;
          }
        }
      }
    }

    .dialog-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;

      &:focus {
        outline: none;
        border-color: #2a8aff;
        box-shadow: 0 0 0 2px rgba(42, 138, 255, 0.2);
      }
    }
  }

  .dialog-footer {
    padding: 16px 20px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 10px;

    button {
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;

      &.btn-outline {
        background-color: white;
        color: #666;
        border: 1px solid #ddd;

        &:hover {
          background-color: #f5f5f5;
        }
      }

      &.btn-primary {
        background-color: #2a8aff;
        color: white;
        border: none;

        &:hover {
          background-color: #1a7aef;
        }
      }
    }
  }
}

@keyframes dialog-appear {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

// ‰øÆÊîπÈ´ò‰∫ÆÊ†∑ÂºèÔºå‰ΩøÂÖ∂Êõ¥ÈÄÇÂêàÈïøÊó∂Èó¥ÊòæÁ§∫
.file-item.new-uploaded-file {
  background-color: rgba(59, 130, 246, 0.05);
  border: 1px solid rgba(59, 130, 246, 0.3);
  box-shadow: 0 0 8px rgba(59, 130, 246, 0.1);
  position: relative;
  
  &::after {
    content: "Êñ∞";
    position: absolute;
    top: -10px; /* Ë∞ÉÊï¥Ê†áËÆ∞‰ΩçÁΩÆÔºå‰ΩøÂÖ∂ÊòæÁ§∫Âú®ÂÖÉÁ¥†Â§ñ */
    right: -10px;
    background-color: #3b82f6;
    color: white;
    font-size: 12px;
    font-weight: bold;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 10; /* ‰ΩøÁî®Êõ¥È´òÁöÑz-indexÁ°Æ‰øùÊòæÁ§∫Âú®ÊúÄ‰∏äÂ±Ç */
  }
}

@keyframes highlight-pulse {
  0% {
    box-shadow: 0 0 5px rgba(59, 130, 246, 0.2);
  }
  50% {
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
  }
  100% {
    box-shadow: 0 0 5px rgba(59, 130, 246, 0.2);
  }
}

// Ê∑ªÂä†‰∏ä‰º†ÂºπÁ™óÊ†∑Âºè
.upload-modal-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1100;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none; /* Èò≤Ê≠¢ÂÆπÂô®Êú¨Ë∫´ÈòªÊ≠¢ÁÇπÂáª‰∫ã‰ª∂ */
}

.upload-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(2px);
  z-index: 1101;
  pointer-events: auto; /* ÂÖÅËÆ∏ËíôÁâàÊé•Êî∂ÁÇπÂáª‰∫ã‰ª∂ */
}
</style>